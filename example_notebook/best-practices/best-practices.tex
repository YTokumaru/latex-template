\chapter{ベストプラクティス}
\label{chap:best-practices}

\section{\LaTeX を書く環境}

\LaTeX を書くための環境を整えることで、効率的にレポートを書くことができる。

\subsection{\LaTeX を書ける主な環境}
\subsubsection{オンライン環境}
近年はオンラインで\LaTeX を書くことができる環境も増えてきている。
手っ取り早く\LaTeX で書き始めることができ、環境構築の負担はほとんどない。
\LaTeX を使い始める初心者にはオススメの方法である。

一方、オンラインでの環境はインターネットへの接続を前提としているため、出先で作業をするといったことに向いていないというデメリットもある。
また、後述するデータ解析からレポート執筆までのフローを自動化するためには、ローカル環境での作業が必要となる。

\subsubsection{Windows環境}
Windowsに\TeX Liveをインストールすることで、ローカル環境で\LaTeX を書くことができるようになる。
しかし、\LaTeX 周りのツールをインストールするのが面倒というデメリットもある。
\verb|choco|などのパッケージマネージャーを使ってツールをインストールし、環境変数を適切に設定する必要がある。
しかし、Windows上での\LaTeX 環境構築についての文献は少ないためあまりおすすめできない。
WindowsユーザーはWSL2などのLinuxの仮想環境上で\LaTeX を書くことを勧める。

\subsubsection{Linux環境}
最も楽に\LaTeX の環境を構築できるのはLinux環境である。
これはインターネット上に多くの文献（日英ともに）が存在し、トラブルシューティングがしやすいためである。
\LaTeX のコンパイル時に必要となるプログラムもデフォルトのパッケージマネージャーでインストールできる場合がほとんどなので、文献上のコマンドをそのまま実行するだけで環境構築を進める事ができる。

\subsection{ディレクトリ構成}

\begin{figure}[H]
    \centering
    \includesvg[width=0.5\textwidth, inkscapeformat=png]{figures/directory.drawio.svg}
    \caption{ディレクトリ構成}
    \label{fig:directory}
\end{figure}

ディレクトリ構成は図\ref{fig:directory}のようにすることを推奨する。
ルートディレクトリを教科ごとに分割し、その中にレポートごとのディレクトリを作成する。
レポートごとのディレクトリの中には\verb|report.tex|というファイルを置き、この中にレポート内容を記述する。
レポートに利用する画像ファイルは\verb|figures/|の中に、実験などで得られたデータは\verb|data/|の中に保存する。
\LaTeX ファイルをコンパイルした際に生成されるファイルは\verb|build/|の中に保存すると、ディレクトリ構成が整理されていて見やすくなる。

\subsection{エディタ周りの環境}

\subsubsection{Visual Studio Code}

VSCodeは設定なしでは単なるテキストエディタではあるが、拡張機能をインストールすることで\LaTeX の編集がしやすくなる。
拡張機能の\verb|LaTeX Workshop|を使うと、\LaTeX ファイルのコンパイル、及びプレビューを行うことができる。
コンパイル時に\verb|synctex|を有効にすることで、プレビュー画面とコードの該当部分の相互参照が可能になる。

\subsubsection{Neovim}

Neovimに\verb|vimtex|のプラグインを導入することで、\verb|.tex|ファイルの自動コンパイルや参照を行うことができる。
pdfファイルのプレビューは\verb|zathura|などのpdfビューアを使うことで行うことができる。

\section{図の作成および挿入}

\subsubsection{図の作成}

実験装置の説明などのために図を作成することがある。
多くの人が使い慣れているという点において、\verb|Microsoft Powerpoint|などを用いて図を作成することが良いが、図を保存して\LaTeX に貼り付ける手間がかかる。
変更が必要になった際に、再度画像として保存して貼り付ける作業をもう一度繰り返す必要がある。

一方、\verb|TikZ|などを用いて\LaTeX 上で図を作成することで修正などは簡単になるが、これも複雑な図を作成する際には手間がかかるという問題点がある。

これらの問題点を解決するために\verb|draw.io|というツールがある。
\verb|drawi.io|はフローチャートやワイヤーフレームなどの図を作成するためのツールである。
操作感は\verb|Powerpoint|などと似ており、直感的に図を作成することができる。
もともとブラウザ上などで利用できたが、2021年に有志によってエキステンションが公開され、VSCode上で利用できるようになった。
つまり、VSCode上で図を作成し、それを\LaTeX から参照することによって図の作成から修正までを効率的に行うことができる。
このエキステンションの良いところは、\verb|my_diagram.drawio.svg|の拡張子で保存すると、そのファイルを直に開くときは\verb|draw.io|で開き直接編集ができ、\LaTeX から参照するときは\verb|svg|ファイルとして認識されることである。
つまり、図を直接編集してそれを参照できるので、\verb|.drawio|ファイルを\verb|svg|や\verb|png|に変換して保存するという手間が省けるのである。
先程のディレクトリ構成図も\verb|VSCode|上の\verb|draw.io|で作成したものである。

\subsubsection{図の挿入}

\verb|draw.io|で\verb|svg|ファイルを作成した場合、\verb|\includesvg|コマンドを用いて\LaTeX に挿入することができる。
\verb|\includesvg|は\verb|inkscape|を用いて\verb|svg|ファイルを\verb|pdf|や\verb|eps|、\verb|png|変換して挿入するコマンドである。
デフォルトでは\verb|pdf|ファイルに変換されるので図表中に\verb|$y = x^2$|のように数式環境を挿入することができる。
図表中の文字をそのまま出力してほしい場合は、\verb|inkscapeformat=png|を指定することで\verb|png|ファイルに変換され、文字がそのまま出力される。

\section{データ解析からレポート執筆までのフロー}

データを分析し、図表などにまとめ、レポートに貼り付けるまでの流れをできるだけ自動化することによって、解析中に変更が生じた図表を自動で更新したりすることができるようになる。

\subsection{データ解析環境}

データ解析には\verb|Jupyter Notebook|を用いる。
これはVSCode上で実行することができるため、データ解析からレポート執筆までのフローを一つのエディタ上で完結させることができる。


\subsection{図の\LaTeX への受け渡し}

\begin{figure}[htbp]
    \centering
    \includesvg[width=0.9\textwidth]{figures/dataflow.drawio.svg}
    \caption{Jupyter Notebookで生成したグラフがpdfに反映されるまでのフロー}
    \label{fig:flow}
\end{figure}

データを解析した結果を図表として\LaTeX に受け渡すためには、\verb|matplotlib|の\verb|savefig|などを用いて、\verb|figures/|ディレクトリ内に画像ファイルを保存する。
これを\LaTeX 側から参照することで、データ解析結果を図表としてレポートに貼り付けることができる。
データ解析をして図表が変わった場合は、コードを実行したときに更新された画像が元の画像を上書きするので、レポートをコンパイルするときには常に最新の図表が反映される。

\subsection{表の\LaTeX への受け渡し}

\LaTeX に解析した表などを\verb|csv|形式で受け渡すことができる。
\verb|pandas|の\verb|to_csv|などを用いれば、\verb|data/|ディレクトリ内に\verb|csv|ファイルを保存することができる。
これを\LaTeX 側から参照することで、データ解析結果を表としてレポートに貼り付けることができる。

\LaTeX に表を挿入する方法はいくつかある。
そのうちいくつかの便利なものを以下に示す。
\begin{itemize}
    \item \verb|csv|ファイルパスだけを指定して\verb|csv|ファイル全体を挿入
    \item \verb|csv|ファイルの特定の列だけを指定して挿入
    \item データの数値を自動的に丸めたり、数字を指数表記に変換、誤差を表示
\end{itemize}
詳しくは\verb|csvsimple|、\verb|siunitx|などのパッケージのドキュメンテーションを参照されたし。

\section{ファイル・データの管理}

レポートあるいは実験データの管理をしっかりするに越したことはないということは言うまでもない。
そこで、データのバージョン管理方法について記しておく。

\subsection{バージョン管理}
バージョン管理は、ファイルやコードの変更履歴を記録し、過去のバージョンにアクセスできるようにするシステムである。
これにより、複数の人が同時に作業しても変更が上書きされることなく、過去の状態に戻したり、変更内容を確認したりすることができる。
主にソフトウェア開発で使用され、\verb|git|などのツールが一般的に用いられる。

もともと\verb|git|はソフトウェア開発のために作られたが、実験データや解析用コードの管理にも使うことができる。
実験データを\verb|git|で管理することの最たるメリットは、生データの保護ができることであろう。
生データを加えた直後にコミットしておけば、とりあえず最初に得られた生データの状態をバックアップすることができる。
後に実験データに不備を見つけて編集することもあるが、誰がいつ修正したかを\verb|git|の履歴に残すことができ、また何か問題が生じた場合にも過去の状態に戻すことができる。
データを知らないうちに上書きしたり、壊してしまうことがなくなるのである。
このような点から、実験データの管理に\verb|git|を用いることで、データの保護とレポートの信頼性を高めることができる。

データ解析においては解析の各段階でコミットを行なうことで、何か問題が生じた際に最後にうまく動いていた状態に戻すことができる。


\subsection{ブランチの利用方法}

\begin{figure}[htbp]
    \centering
    \includesvg[width=0.8\textwidth]{figures/git_branch.drawio.svg}
    \caption{ブランチの様子}
    \label{fig:branch}
\end{figure}

ブランチとは、プロジェクト内で作業の「枝分かれ」を作る方法である。
ブランチを利用することで、メインのプロジェクトに影響を与えずに、新しいアイデアの試行や機能の追加を行うことができる。
たとえば、同時並行で別のレポートを作成する際には、それぞれのレポートに対して別のブランチを作成することで、それぞれの作業がお互いに影響を及ぼすことなく作業を進めることができる。

作業が完了し、問題がない場合には、ブランチを元のプロジェクトに合体させる。このようにして、レポートにおける複数の作業が同時進行できるため、他の人の作業に影響を与えることなく、より柔軟にレポートを進めることができる。

\subsection{Preambleの管理}
レポートなどで必要になるパッケージや設定をあらかじめpreambleとして\verb|.tex|ファイルに記述しておくことで、レポートを書く際にこれを読み込むだけで設定を反映することができる。

このpreambleはプロジェクトと同じ\verb|git|で管理することもできるが、preambleを別のレポジトリ入れて管理し、\verb|git submodule|を用いてプロジェクトに取り込むこともできる。
この方法を用いることで、複数のプロジェクトで同じpreambleを使い回すことができ、またpreambleの更新があった場合には、\verb|git submodule update|を行うことで、すべてのプロジェクトに反映することができるという利点がある。

\section{コンパイルエラーを解決する}

\subsection{エラーメッセージを読む}

コンパイルした際のログは、デフォルトではpdfと同じディレクトリに生成される\footnote{そもそもコンパイルが開始されないと出力されないので注意が必要。コンパイル前に何かつまずくとログは見れない。}。
このログの中にはコンパイル時に発生したエラーや警告が記録されている。
基本的にエラーが起きるまでコンパイルが進むため、エラーはログの最後に記録されることが多い。
エラーが最後に記述されていない場合でも文字列検索で「error」や「warning」などのキーワードを探すことでエラー箇所を特定することができる。

\subsection{ドキュメンテーションを参照する}

使用しているパッケージの仕様や使い方を知りたい場合は、そのパッケージのドキュメントを参照することが重要である。
パッケージのドキュメンテーションが最も正確で最新な情報源であり、エラー解決やパッケージで提供されている機能を理解するためには必須である。
Googleでパッケージ名を検索すると、CTAN（Comprehensive \TeX Archive Network）のページが表示される。
CTANは\TeX 関連のパッケージやフォントなどの情報を提供しているサイトであり、パッケージのドキュメンテーションのpdfファイルを閲覧することができるようになっている。